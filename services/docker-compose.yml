services:
  # ========== Servicio 1: Ingestion API ==========
  ingestion-api:
    build: ./ingestion-api
    container_name: ingestion-api
    ports:
      - "8001:8000"
    environment:
      - THINGSBOARD_URL=${THINGSBOARD_URL}
      - TB_AMASADO_TOKEN=${TB_AMASADO_TOKEN}
      - TB_FERMENTACION_TOKEN=${TB_FERMENTACION_TOKEN}
      - WEBSOCKET_URL=http://websocket-gateway:8000
    depends_on:
      - websocket-gateway
    networks:
      - iot-network
    restart: unless-stopped

  # ========== Servicio 2: Scheduler ==========
  scheduler-service:
    build: ./scheduler-service
    container_name: scheduler-service
    environment:
      - ORCHESTRATOR_URL=http://predictor-orchestrator:8000
      - DATASET_COLOR_PATH=/datasets/color
      - DATASET_TEXTURE_PATH=/datasets/texture
      - DATASET_SIZE_PATH=/datasets/size
      - SCHEDULE_INTERVAL=60
      - NUM_IMAGES=20
    volumes:
      # El scheduler necesita acceso a TODOS los datasets para seleccionar im치genes
      - ../ml/datasets/dataset-color:/datasets/color:ro
      - ../ml/datasets/dataset-texture:/datasets/texture:ro
      - ../ml/datasets/dataset-size:/datasets/size:ro
    depends_on:
      - predictor-orchestrator
    networks:
      - iot-network
    restart: unless-stopped

  # ========== Servicio 3: Predictor Orchestrator ==========
  predictor-orchestrator:
    build: ./predictor-orchestrator
    container_name: predictor-orchestrator
    ports:
      - "8002:8000"
    environment:
      - ML_SERVICE_COLOR_URL=http://ml-service-color:8000
      - ML_SERVICE_TEXTURE_URL=http://ml-service-texture:8000
      - ML_SERVICE_SIZE_URL=http://ml-service-size:8000
      - THINGSBOARD_URL=${THINGSBOARD_URL}
      - TB_PREDICTIONS_COLOR_TOKEN=${TB_PREDICTIONS_COLOR_TOKEN}
      - TB_PREDICTIONS_TEXTURE_TOKEN=${TB_PREDICTIONS_TEXTURE_TOKEN}
      - TB_PREDICTIONS_SIZE_TOKEN=${TB_PREDICTIONS_SIZE_TOKEN}
      - WEBSOCKET_URL=http://websocket-gateway:8000
    depends_on:
      - ml-service-color
      - ml-service-texture
      - ml-service-size
      - websocket-gateway
    networks:
      - iot-network
    restart: unless-stopped

  # ========== Servicio 4: ML Service - Color ==========
  ml-service-color:
    build: ./ml-service-color
    container_name: ml-service-color
    ports:
      - "8101:8000"
    environment:
      - MODEL_PATH=/models/modelo_color.h5
    volumes:
      # Solo monta el modelo (read-only)
      - ../ml/models/modelo-color/modelo_color.h5:/models/modelo_color.h5:ro
      # Monta el dataset para poder leer las im치genes por ruta
      - ../ml/datasets/dataset-color:/datasets/color:ro
    networks:
      - iot-network
    restart: unless-stopped

  # ========== Servicio 5: ML Service - Texture ==========
  ml-service-texture:
    build: ./ml-service-texture
    container_name: ml-service-texture
    ports:
      - "8102:8000"
    environment:
      - MODEL_PATH=/models/modelo_texture.h5
    volumes:
      # Solo monta el modelo (read-only)
      - ../ml/models/modelo-texture/modelo_texture.h5:/models/modelo_texture.h5:ro
      # Monta el dataset para poder leer las im치genes por ruta
      - ../ml/datasets/dataset-texture:/datasets/texture:ro
    networks:
      - iot-network
    restart: unless-stopped

  # ========== Servicio 6: ML Service - Size ==========
  ml-service-size:
    build: ./ml-service-size
    container_name: ml-service-size
    ports:
      - "8103:8000"
    environment:
      - MODEL_PATH=/models/modelo_size.h5
      - CONFIG_PATH=/models/config.json
      - SCALER_PATH=/models/output_scaler.pkl
    volumes:
      # Solo monta los modelos (read-only)
      - ../ml/models/modelo-size:/models:ro
      # Monta el dataset para poder leer las im치genes por ruta
      - ../ml/datasets/dataset-size:/datasets/size:ro
    networks:
      - iot-network
    restart: unless-stopped

  # ========== Servicio 7: WebSocket Gateway ==========
  websocket-gateway:
    build: ./websocket-gateway
    container_name: websocket-gateway
    ports:
      - "8003:8000"
    networks:
      - iot-network
    restart: unless-stopped

  # ========== Servicio 8: Dashboard ==========
  # NOTA: Comentado temporalmente hasta crear el dashboard
  # dashboard:
  #   build: ./dashboard
  #   container_name: dashboard
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - REACT_APP_WS_URL=ws://localhost:8003
  #     - REACT_APP_INGESTION_API=http://localhost:8001
  #     - REACT_APP_ORCHESTRATOR_API=http://localhost:8002
  #   depends_on:
  #     - websocket-gateway
  #     - ingestion-api
  #     - predictor-orchestrator
  #   networks:
  #     - iot-network
  #   restart: unless-stopped

networks:
  iot-network:
    driver: bridge